name: Build Static Binary

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: xianyu-super-butler-linux-amd64
          - os: windows-latest
            platform: windows
            artifact_name: xianyu-super-butler-windows-amd64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ========== 构建前端 ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: pnpm install --no-frozen-lockfile

      - name: Build frontend
        working-directory: ./frontend
        run: npx vite build

      # ========== 编译 Python 为二进制 ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build binary with PyInstaller (Linux)
        if: matrix.platform == 'linux'
        run: |
          pyinstaller \
            --name xianyu-super-butler \
            --onedir \
            --noconfirm \
            --clean \
            --add-data "static:static" \
            --add-data "global_config.yml:." \
            --add-data "nginx:nginx" \
            --add-data "captcha_control.html:." \
            --add-data "utils:utils" \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.lifespan \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.lifespan.off \
            --hidden-import uvicorn.protocols \
            --hidden-import uvicorn.protocols.http \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.http.httptools_impl \
            --hidden-import uvicorn.protocols.websockets \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.wsproto_impl \
            --hidden-import uvicorn.protocols.websockets.websockets_impl \
            --hidden-import uvicorn.loops \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.loops.asyncio \
            --hidden-import uvicorn.loops.uvloop \
            --hidden-import fastapi \
            --hidden-import pydantic \
            --hidden-import multipart \
            --hidden-import yaml \
            --hidden-import loguru \
            --hidden-import websockets \
            --hidden-import aiohttp \
            --hidden-import httpx \
            --hidden-import openai \
            --hidden-import PIL \
            --hidden-import qrcode \
            --hidden-import cryptography \
            --hidden-import passlib \
            --hidden-import jwt \
            --hidden-import pandas \
            --hidden-import openpyxl \
            --hidden-import xlsxwriter \
            --hidden-import psutil \
            --hidden-import execjs \
            --hidden-import blackboxprotobuf \
            --hidden-import dateutil \
            --hidden-import email_validator \
            --hidden-import reply_server \
            --hidden-import ai_reply_engine \
            --hidden-import api_captcha_remote \
            --hidden-import config \
            --hidden-import cookie_manager \
            --hidden-import db_manager \
            --hidden-import file_log_collector \
            --hidden-import order_status_handler \
            --hidden-import order_status_query_playwright \
            --hidden-import secure_confirm_decrypted \
            --hidden-import secure_confirm_ultra \
            --hidden-import secure_freeshipping_decrypted \
            --hidden-import secure_freeshipping_ultra \
            --hidden-import XianyuAutoAsync \
            --collect-submodules uvicorn \
            --collect-submodules fastapi \
            --collect-submodules pydantic \
            --collect-submodules starlette \
            Start.py

      - name: Build binary with PyInstaller (Windows)
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          pyinstaller \
            --name xianyu-super-butler \
            --onedir \
            --noconfirm \
            --clean \
            --add-data "static;static" \
            --add-data "global_config.yml;." \
            --add-data "nginx;nginx" \
            --add-data "captcha_control.html;." \
            --add-data "utils;utils" \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.lifespan \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.lifespan.off \
            --hidden-import uvicorn.protocols \
            --hidden-import uvicorn.protocols.http \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.http.httptools_impl \
            --hidden-import uvicorn.protocols.websockets \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.wsproto_impl \
            --hidden-import uvicorn.protocols.websockets.websockets_impl \
            --hidden-import uvicorn.loops \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.loops.asyncio \
            --hidden-import uvicorn.loops.uvloop \
            --hidden-import fastapi \
            --hidden-import pydantic \
            --hidden-import multipart \
            --hidden-import yaml \
            --hidden-import loguru \
            --hidden-import websockets \
            --hidden-import aiohttp \
            --hidden-import httpx \
            --hidden-import openai \
            --hidden-import PIL \
            --hidden-import qrcode \
            --hidden-import cryptography \
            --hidden-import passlib \
            --hidden-import jwt \
            --hidden-import pandas \
            --hidden-import openpyxl \
            --hidden-import xlsxwriter \
            --hidden-import psutil \
            --hidden-import execjs \
            --hidden-import blackboxprotobuf \
            --hidden-import dateutil \
            --hidden-import email_validator \
            --hidden-import reply_server \
            --hidden-import ai_reply_engine \
            --hidden-import api_captcha_remote \
            --hidden-import config \
            --hidden-import cookie_manager \
            --hidden-import db_manager \
            --hidden-import file_log_collector \
            --hidden-import order_status_handler \
            --hidden-import order_status_query_playwright \
            --hidden-import secure_confirm_decrypted \
            --hidden-import secure_confirm_ultra \
            --hidden-import secure_freeshipping_decrypted \
            --hidden-import secure_freeshipping_ultra \
            --hidden-import XianyuAutoAsync \
            --collect-submodules uvicorn \
            --collect-submodules fastapi \
            --collect-submodules pydantic \
            --collect-submodules starlette \
            Start.py

      # ========== 打包产物 ==========
      - name: Package artifact (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd dist
          tar -czf ../${{ matrix.artifact_name }}.tar.gz xianyu-super-butler/

      - name: Package artifact (Windows)
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          cd dist
          7z a -tzip ../${{ matrix.artifact_name }}.zip xianyu-super-butler/

      # ========== 上传构建产物 ==========
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.gz
            ${{ matrix.artifact_name }}.zip
          if-no-files-found: ignore

  # ========== 创建 Release (仅 tag 触发) ==========
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
